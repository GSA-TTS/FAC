---
name: Add BPMN renders
# Whenever a PR contains changes to BPMN files, render (or remove) the
# corresponding PNG and SVG output, then raise a new pull-request to add/remove
# those files onto the branch. (Note that this will count as a "failing test", so
# the base branch won't be merge-able until the PR with the images is merged
# into it!)
#
# Cribs heavily from this example:
# https://github.com/peter-evans/create-pull-request/blob/main/docs/examples.md#use-case-create-a-pull-request-to-modifyfix-pull-requests

on:
  pull_request:
    paths:
      - 'docs/bpmn-workflow-models/*.bpmn'

jobs:
  add-or-update-BPMN-diagrams:
    # Check that the PR is not raised by this workflow (avoiding recursion) and is not from a fork
    if: startsWith(github.head_ref, 'auto/bpmn-patches') == false && github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    # env:
    #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - name: Install bpmn-to-image
        run: npm install -g bpmn-to-image
      - id: files
        uses: jitterbit/get-changed-files@v1
      - name: Remove images for each removed BPMN file
        # Docs at https://github.com/marketplace/actions/get-all-changed-files
        run: |    
          for changed_file in ${{ steps.files.outputs.removed }} ; do
            extension=${changed_file##*.}
            if [ $extension = "bpmn" ] ; then 
              rendered_file=$(dirname $changed_file)/$(basename $changed_file .bpmn)
              rm -f ${rendered_file}.png ${rendered_file}.svg
            fi
          done
      - name: Render image output for each added/changed/renamed BPMN file
        run: |    
          for changed_file in ${{ steps.files.outputs.added_modified }} ; do
            extension=${changed_file##*.}
            if [ $extension = "bpmn" ] ; then 
              rendered_file=$(dirname $changed_file)/$(basename $changed_file .bpmn)
              bpmn-to-image ${changed_file}:${rendered_file}.png,${rendered_file}.svg
            fi
          done
      - name: See if we need to make a patch branch
        id: vars
        run: |
          branchname="bpmn-patches/${{ github.head_ref }}"
          echo "branchname=${branchname}" >> $GITHUB_OUTPUT
          imagesupdated=$(git status --porcelain | cut -d ' ' -f 2 | wc -l)
          echo "imagesupdated=${imagesupdated}" >> $GITHUB_OUTPUT
      - name: Create PR with patch
        if: steps.vars.outputs.imagesupdated != 0
        uses: peter-evans/create-pull-request@v4
        with:
          commit-message: Adds/updates BPMN images for ${{ github.head_ref }}
          title: Update BPMN images
          body: This is an auto-generated PR to add/update BPMN images on ${{ github.head_ref }}.
          labels: bpmn-to-image, automated pr
          branch: ${{ steps.vars.outputs.branchname }}
          base: ${{ github.head_ref }}
      - name: Fail the workflow if bpmn-to-image made changes
        if: steps.vars.outputs.imagesupdated != 0
        run: exit 1
