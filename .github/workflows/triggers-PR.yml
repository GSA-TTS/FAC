---
name: Tests for PRs
on:
  pull_request:
    branches:
      - main
      - prod
    paths:
      - '**'
      - '!docs/**'
      - 'docs/bpmn-workflow-models/**'
  workflow_dispatch: null

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      requirements: ${{ steps.filter.outputs.requirements }}
      dev-requirements: ${{ steps.filter.outputs.devrequirements }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            requirements:
              - 'backend/requirements.txt'
            devrequirements:
              - 'backend/dev-requirements.txt'
            docker:
              - 'backend/Dockerfile'

  # Testing for all main and prod PRs
  test-and-lint:
    needs: [changes]
    if: ${{ needs.changes.outputs.requirements == 'true' }} || ${{ needs.changes.outputs.dev-requirements == 'true' }} || ${{ needs.changes.outputs.docker == 'true' }}
    uses: ./.github/workflows/build-and-test.yml
    secrets: inherit

  test-and-lint-ghcr:
    needs: [changes]
    if: ${{ needs.changes.outputs.requirements != 'true' }} && ${{ needs.changes.outputs.dev-requirements != 'true' }} && ${{ needs.changes.outputs.docker != 'true' }}
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Update BPMN diagram
  sync-BPMN:
    uses: ./.github/workflows/add-bpmn-renders.yml
    secrets: inherit

  # Create terraform plan as part of the PR review process

  # PR to main bafore dev deploy
  plan-terraform-dev:
    if: ${{ github.base_ref == 'main' }}
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      environment: "dev"
    secrets: inherit

  plan-terraform-management:
    if: ${{ github.base_ref == 'main' }}
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      environment: "management"
    secrets: inherit

  # PR for release before staging deploy
  plan-terraform-stage:
    if: ${{ github.base_ref == 'prod' }}
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      environment: "staging"
    secrets: inherit

  # PR for release before prod deploy
  plan-terraform-prod:
    # This uses the same trigger as staging because prod deploy is tied to tags
    if: ${{ github.base_ref == 'prod' }}
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      environment: "production"
    secrets: inherit

