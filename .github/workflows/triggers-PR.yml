---
name: Deploy to cloud.gov
on:
  pull_request:
    branches:
      - main
      - prod
    paths-ignore:
      - 'docs/**'
  workflow_dispatch: null

jobs:
  # testing for all main and prod PRs
  test-and-lint:
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # testing for PRs with BPMN
  lint-BPMN:
    with:
      filters: |
        workflows:
          - 'docs/bpmn-workflow-models/**' 
    uses: ./.github/workflows/add-bpmn-renders.yml
    secrets: inherit

  # PR to main bafore dev deploy
  plan-terraform-dev:
    if: github.event.pull_request.base.ref == 'main'
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      envionment: "dev"
    secrets: inherit

  plan-terraform-management:
    if: github.event.pull_request.base.ref == 'main'
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      envionment: "management"
    secrets: inherit

  # PR for release before staging deploy
  plan-terraform-stage:
    if: github.event.pull_request.base.ref == 'prod'
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      envionment: "staging"
    secrets: inherit

  # PR for release before prod deploy
  plan-terraform-prod:
    # This uses the same trigger as staging because prod deploy is tied to tags
    if: github.event.pull_request.base.ref == 'prod'
    uses: ./.github/workflows/terraform-plan-env.yml
    with:
      envionment: "production"
    secrets: inherit

# Can consolidate dev, staging and prod (management still has to be seperate) as a next step; keeping it explicit for now
  # plan-terraform:
  #   strategy: 
  #     matrix:
  #       target: ["management", "dev", "staging", "production"]
  #   uses: ./.github/workflows/terraform-plan-env.yml
  #   with:
  #     environment: ${{ matrix.target }}
  #   secrets: inherit